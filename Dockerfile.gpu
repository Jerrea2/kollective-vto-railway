# ---------------------------------------------------------
# Base Image
# ---------------------------------------------------------
FROM nvidia/cuda:11.8.0-runtime-ubuntu22.04

# ---------------------------------------------------------
# System Dependencies
# ---------------------------------------------------------
RUN apt-get update && apt-get install -y \
    git \
    wget \
    curl \
    python3 \
    python3-pip \
    libgl1 \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------
# Working Directory
# ---------------------------------------------------------
WORKDIR /app

# ---------------------------------------------------------
# Copy application code
# ---------------------------------------------------------
COPY . /app

# ---------------------------------------------------------
# Install Python dependencies
# ---------------------------------------------------------
RUN pip3 install --upgrade pip
RUN pip3 install -r /app/requirements.txt --no-cache-dir

# ---------------------------------------------------------
# BAKE IDM-VTON WEIGHTS INTO IMAGE
# These weights come from your repo under models/vendor-IDM-VTON
# ---------------------------------------------------------
COPY models/vendor-IDM-VTON /models/vendor-IDM-VTON
ENV IDM_VTON_MODEL_DIR=/models/vendor-IDM-VTON

# ---------------------------------------------------------
# Expose port for RunPod inference server
# ---------------------------------------------------------
EXPOSE 8000

# ---------------------------------------------------------
# Entry Point
# YOUR inference server is always started with worker.py
# ---------------------------------------------------------
CMD ["python3", "worker.py"]

